/*!
 * APNG Parser v0.0.2 | MIT Licence | Kenta Moriuchi (@printf_moriken)
 *
 * This Program is inspired by APNG-canvas.
 * @copyright 2011 David Mzareulyan
 * @link https://github.com/davidmz/apng-canvas
 * @license https://github.com/davidmz/apng-canvas/blob/master/LICENSE (MIT License)
 */
!function(t){"use strict";function e(){}function r(t){this.width=0,this.height=0,this.numPlays=0,this.frames=[],this.playTime=0,this._onload=[],this.loaded=!1,this._urlToPNGFrames(t)}function a(t){for(var e=0,r=0;4>r;++r)e+=t.charCodeAt(r)<<8*(3-r);return e}function s(t){for(var e=0,r=0;2>r;++r)e+=t.charCodeAt(r)<<8*(1-r);return e}function n(t,e){var r="";return r+=o(e.length),r+=t,r+=e,r+=o(d(t+e))}function o(t){return String.fromCharCode(t>>24&255,t>>16&255,t>>8&255,255&t)}function i(){this.parts=[]}function d(t){for(var e=-1,r=0,a=t.length;a>r;++r)e=e>>>8^p[255&(e^t.charCodeAt(r))];return-1^e}var h=navigator.userAgent.match(/msie [9.]/i);e.prototype.read=function(t){var e=new r(t);return e},t.APNGParser=e,r.prototype.on=function(t,e){"load"===t&&this._onload.push(e)},r.prototype._urlToPNGFrames=function(t){var e=this,r=new XMLHttpRequest,a="undefined"!=typeof r.responseType,s="undefined"!=typeof r.overrideMimeType&&!a;r.open("GET",t,!0),a?r.responseType="blob":s&&r.overrideMimeType("text/plain; charset=x-user-defined"),r.onreadystatechange=function(){if(4==this.readyState&&200==this.status)if(a){var t=new FileReader;"undefined"!=typeof t.readAsBinaryString?(t.onload=function(){e._parseAPNG(this.result)},t.readAsBinaryString(this.response)):(t.onload=function(){for(var t="",r=new Uint8Array(this.result),a=r.byteLength,s=0;a>s;++s)t+=String.fromCharCode(r[s]);e._parseAPNG(t)},t.readAsArrayBuffer(this.response))}else{var r="";if(h)for(var s=APNGIEBinaryToBinStr(this.responseBody),n=0,o=s.length;o>n;++n){var i=s.charCodeAt(n);r+=String.fromCharCode(255&i,i>>8&255)}else for(var d=this.responseText,u=0,p=d.length;p>u;++u)r+=String.fromCharCode(255&d.charCodeAt(u));e._parseAPNG(r)}else 4==this.readyState&&console.error("Can't read APNG date")},r.send()},r.prototype._parseAPNG=function(t){t.substr(0,8)!==u&&console.error("This File is not PNG");var e,r,d,h,p="",f="",c=!1,l=8,y=null;do{switch(r=a(t.substr(l,4)),d=t.substr(l+4,4)){case"IHDR":h=t.substr(l+8,r),e=h,this.width=a(h.substr(0,4)),this.height=a(h.substr(4,4));break;case"acTL":c=!0,this.numPlays=a(t.substr(l+8+4,4));break;case"fcTL":y&&this.frames.push(y),h=t.substr(l+8,r),y={},y.width=a(h.substr(4,4)),y.height=a(h.substr(8,4)),y.left=a(h.substr(12,4)),y.top=a(h.substr(16,4));var b=s(h.substr(20,2)),g=s(h.substr(22,2));0===g&&(g=100),y.delay=1e3*b/g,y.delay<=10&&(y.delay=100),this.playTime+=y.delay,y.disposeOp=h.charCodeAt(24),y.blendOp=h.charCodeAt(25),y.dataParts=[];break;case"fdAT":y&&y.dataParts.push(t.substr(l+8+4,r-4));break;case"IDAT":y&&y.dataParts.push(t.substr(l+8,r));break;case"IEND":f=t.substr(l,r+12);break;default:p+=t.substr(l,r+12)}l+=12+r}while("IEND"!==d&&l<t.length);y&&this.frames.push(y),c||console.error("Non-animated PNG");for(var m=0,v=this,A=0;A<this.frames.length;++A){var P=new Image;y=this.frames[A],y.img=P,P.onload=function(){++m,m==v.frames.length&&v._loadend()},P.onerror=function(){console.error("Image creation error")};var C=new i;C.append(u),e=o(y.width)+o(y.height)+e.substr(8),C.append(n("IHDR",e)),C.append(p);for(var T=0;T<y.dataParts.length;++T)C.append(n("IDAT",y.dataParts[T]));C.append(f),P.src=C.getUrl("image/png"),delete y.dataParts}},r.prototype._loadend=function(){this.loaded=!0;for(var t=0,e=this._onload.length;e>t;++t)this._onload.shift().call(this)};var u=String.fromCharCode(137,80,78,71,13,10,26,10);i.prototype.append=function(t){this.parts.push(t)},i.prototype.getUrl=function(e){return t.btoa?"data:"+e+";base64,"+btoa(this.parts.join("")):"data:"+e+","+escape(this.parts.join(""))},h&&document.addEventListener("DOMContentLoaded",function(){var t=document.createElement("script");t.setAttribute("type","text/vbscript"),t.text="Function APNGIEBinaryToBinStr(Binary)\r\n   APNGIEBinaryToBinStr = CStr(Binary)\r\nEnd Function\r\n",document.body.appendChild(t)});for(var p=new Array(256),f=0;256>f;++f){for(var c=f,l=0;8>l;++l)c=1&c?3988292384^c>>>1:c>>>1;p[f]=c}}(this);