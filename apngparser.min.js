/*!
 * APNG Parser v0.0.2 | MIT Licence | Kenta Moriuchi (@printf_moriken)
 *
 * This Program is inspired by APNG-canvas.
 * @copyright 2011 David Mzareulyan
 * @link https://github.com/davidmz/apng-canvas
 * @license https://github.com/davidmz/apng-canvas/blob/master/LICENSE (MIT License)
 */
!function(e){"use strict";function t(){}function r(e){this.width=0,this.height=0,this.numPlays=0,this.frames=[],this.playTime=0,this._onload=[],this.loaded=!1,this._urlToPNGFrames(e)}function a(e){for(var t=0,r=0;4>r;++r)t+=e.charCodeAt(r)<<8*(3-r);return t}function n(e){for(var t=0,r=0;2>r;++r)t+=e.charCodeAt(r)<<8*(1-r);return t}function s(e,t){var r="";return r+=o(t.length),r+=e,r+=t,r+=o(d(e+t))}function o(e){return String.fromCharCode(e>>24&255,e>>16&255,e>>8&255,255&e)}function i(){this.parts=[]}function d(e){for(var t=-1,r=0,a=e.length;a>r;++r)t=t>>>8^p[255&(t^e.charCodeAt(r))];return-1^t}var h=navigator.userAgent.match(/msie [9.]/i);t.prototype.read=function(e){var t=new r(e);return t},e.APNGParser=t,r.prototype.on=function(e,t){"load"===e&&this._onload.push(t)},r.prototype._urlToPNGFrames=function(t){var r=this,a=new XMLHttpRequest,n=e.Blob,s=e.BlobBuilder||e.WebKitBlobBuilder||e.MSBlobBuilder||e.MozBlobBuilder,o="undefined"!=typeof a.responseType&&("undefined"!=typeof n||"undefined"!=typeof s),i="undefined"!=typeof a.overrideMimeType&&!o;a.open("GET",t,!0),o?a.responseType="arraybuffer":i&&a.overrideMimeType("text/plain; charset=x-user-defined"),a.onreadystatechange=function(){if(4==this.readyState&&200==this.status)if(o){var e=new FileReader;if("readAsBinaryString"in e)if(e.onload=function(){r._parseAPNG(this.result)},"undefined"!=typeof n){var t=new n([this.response]);e.readAsBinaryString(t)}else{var a=new s;a.append(this.response),e.readAsBinaryString(a.getBlob())}else{for(var i="",d=new Uint8Array(this.response),u=d.byteLength,p=0;u>p;++p)i+=String.fromCharCode(d[p]);r._parseAPNG(i)}}else{var f="";if(h)for(var l=APNGIEBinaryToBinStr(this.responseBody),c=0,y=l.length;y>c;++c){var b=l.charCodeAt(c);f+=String.fromCharCode(255&b,b>>8&255)}else for(var g=this.responseText,v=0,m=g.length;m>v;++v)f+=String.fromCharCode(255&g.charCodeAt(v));r._parseAPNG(f)}else 4==this.readyState&&console.error("Can't read APNG date")},a.send()},r.prototype._parseAPNG=function(e){e.substr(0,8)!==u&&console.error("This File is not PNG");var t,r="",d="",h=!1,p=8,f=null;do{var l,c=a(e.substr(p,4)),y=e.substr(p+4,4);switch(y){case"IHDR":l=e.substr(p+8,c),t=l,this.width=a(l.substr(0,4)),this.height=a(l.substr(4,4));break;case"acTL":h=!0,this.numPlays=a(e.substr(p+8+4,4));break;case"fcTL":f&&this.frames.push(f),l=e.substr(p+8,c),f={},f.width=a(l.substr(4,4)),f.height=a(l.substr(8,4)),f.left=a(l.substr(12,4)),f.top=a(l.substr(16,4));var b=n(l.substr(20,2)),g=n(l.substr(22,2));0===g&&(g=100),f.delay=1e3*b/g,f.delay<=10&&(f.delay=100),this.playTime+=f.delay,f.disposeOp=l.charCodeAt(24),f.blendOp=l.charCodeAt(25),f.dataParts=[];break;case"fdAT":f&&f.dataParts.push(e.substr(p+8+4,c-4));break;case"IDAT":f&&f.dataParts.push(e.substr(p+8,c));break;case"IEND":d=e.substr(p,c+12);break;default:r+=e.substr(p,c+12)}p+=12+c}while("IEND"!==y&&p<e.length);f&&this.frames.push(f),h||console.error("Non-animated PNG");for(var v=0,m=this,A=0;A<this.frames.length;++A){var B=new Image;f=this.frames[A],f.img=B,B.onload=function(){++v,v==m.frames.length&&m._loadend()},B.onerror=function(){console.error("Image creation error")};var P=new i;P.append(u),t=o(f.width)+o(f.height)+t.substr(8),P.append(s("IHDR",t)),P.append(r);for(var C=0;C<f.dataParts.length;++C)P.append(s("IDAT",f.dataParts[C]));P.append(d),B.src=P.getUrl("image/png"),delete f.dataParts}},r.prototype._loadend=function(){this.loaded=!0;for(var e=0,t=this._onload.length;t>e;++e)this._onload.shift().call(this)};var u=String.fromCharCode(137,80,78,71,13,10,26,10);i.prototype.append=function(e){this.parts.push(e)},i.prototype.getUrl=function(t){return e.btoa?"data:"+t+";base64,"+btoa(this.parts.join("")):"data:"+t+","+escape(this.parts.join(""))},h&&document.addEventListener("DOMContentLoaded",function(){var e=document.createElement("script");e.setAttribute("type","text/vbscript"),e.text="Function APNGIEBinaryToBinStr(Binary)\r\n   APNGIEBinaryToBinStr = CStr(Binary)\r\nEnd Function\r\n",document.body.appendChild(e)});for(var p=new Array(256),f=0;256>f;++f){for(var l=f,c=0;8>c;++c)l=1&l?3988292384^l>>>1:l>>>1;p[f]=l}}(this);