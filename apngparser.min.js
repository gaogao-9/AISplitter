/*!
 * APNG Parser v0.0.1 | MIT Licence | Kenta Moriuchi (@printf_moriken)
 *
 * This Program is inspired by APNG-canvas.
 * @copyright 2011 David Mzareulyan
 * @link https://github.com/davidmz/apng-canvas
 * @license https://github.com/davidmz/apng-canvas/blob/master/LICENSE (MIT License)
 */
!function(e){"use strict";function t(t){this.binary=null,this.image=null,this.loaded=!1,this._onload=[];var r=this,a=new XMLHttpRequest,s=e.BlobBuilder||e.WebKitBlobBuilder||e.MSBlobBuilder||e.MozBlobBuilder,n=navigator.userAgent.match(/msie [9.]/i),i="undefined"!=typeof a.responseType&&"undefined"!=typeof s,o="undefined"!=typeof a.overrideMimeType&&!i;a.open("GET",t,!0),i?a.responseType="arraybuffer":o&&a.overrideMimeType("text/plain; charset=x-user-defined"),a.onreadystatechange=function(){if(4==this.readyState&&200==this.status)if(i){var e=new FileReader;if("readAsBinaryString"in e){e.onload=function(){r._parseImageObject(this.result)};var t=new s;t.append(this.response),e.readAsBinaryString(t.getBlob())}else{for(var a="",o=new Uint8Array(this.response),d=o.byteLength,h=0;d>h;++h)a+=String.fromCharCode(o[h]);r._parseImageObject(a)}}else{var u="";if(n)for(var p=APNGIEBinaryToBinStr(this.responseBody),l=0,c=p.length;c>l;++l){var f=p.charCodeAt(l);u+=String.fromCharCode(255&f,f>>8&255)}else for(var b=this.responseText,h=0,g=b.length;g>h;++h)u+=String.fromCharCode(255&b.charCodeAt(h));r._parseImageObject(u)}else 4==this.readyState&&console.error("Can't read APNG date")},a.send()}function r(e,t){this.width=0,this.height=0,this.numPlays=0,this.frames=[],this.playTime=0,this._parseAPNG(e,t)}function a(e){for(var t=0,r=0;4>r;++r)t+=e.charCodeAt(r)<<8*(3-r);return t}function s(e){for(var t=0,r=0;2>r;++r)t+=e.charCodeAt(r)<<8*(1-r);return t}function n(e,t){var r="";return r+=i(t.length),r+=e,r+=t,r+=i(d(e+t))}function i(e){return String.fromCharCode(e>>24&255,e>>16&255,e>>8&255,255&e)}function o(){this.parts=[]}function d(e){for(var t=-1,r=0,a=e.length;a>r;++r)t=t>>>8^u[255&(t^e.charCodeAt(r))];return-1^t}t.prototype.on=function(e,t){"load"===e&&this._onload.push(t)},t.prototype._parseImageObject=function(e){this.binary=e,this.image=new r(this,e)},t.prototype._loadend=function(){this.loaded=!0;for(var e=0,t=this._onload.length;t>e;++e)this._onload[e].call(this)},e.APNGParser=t,r.prototype._parseAPNG=function(e,t){t.substr(0,8)!=h&&console.error("This File is not PNG");var r,d="",u="",p=!1,l=8,c=null;do{var f,b=a(t.substr(l,4)),g=t.substr(l+4,4);switch(g){case"IHDR":f=t.substr(l+8,b),r=f,this.width=a(f.substr(0,4)),this.height=a(f.substr(4,4));break;case"acTL":p=!0,this.numPlays=a(t.substr(l+8+4,4));break;case"fcTL":c&&this.frames.push(c),f=t.substr(l+8,b),c={},c.width=a(f.substr(4,4)),c.height=a(f.substr(8,4)),c.left=a(f.substr(12,4)),c.top=a(f.substr(16,4));var y=s(f.substr(20,2)),m=s(f.substr(22,2));0===m&&(m=100),c.delay=1e3*y/m,c.delay<=10&&(c.delay=100),this.playTime+=c.delay,c.disposeOp=f.charCodeAt(24),c.blendOp=f.charCodeAt(25),c.dataParts=[];break;case"fdAT":c&&c.dataParts.push(t.substr(l+8+4,b-4));break;case"IDAT":c&&c.dataParts.push(t.substr(l+8,b));break;case"IEND":u=t.substr(l,b+12);break;default:d+=t.substr(l,b+12)}l+=12+b}while("IEND"!==g&&l<t.length);c&&this.frames.push(c),p||console.error("Non-animated PNG");for(var v=0,A=this,C=0;C<this.frames.length;++C){var B=new Image;c=this.frames[C],c.img=B,B.onload=function(){++v,v==A.frames.length&&e._loadend()},B.onerror=function(){console.error("Image creation error")};var P=new o;P.append(h),r=i(c.width)+i(c.height)+r.substr(8),P.append(n("IHDR",r)),P.append(d);for(var T=0;T<c.dataParts.length;++T)P.append(n("IDAT",c.dataParts[T]));P.append(u),B.src=P.getUrl("image/png"),delete c.dataParts}};var h=String.fromCharCode(137,80,78,71,13,10,26,10);o.prototype.append=function(e){this.parts.push(e)},o.prototype.getUrl=function(t){return e.btoa?"data:"+t+";base64,"+btoa(this.parts.join("")):"data:"+t+","+escape(this.parts.join(""))},navigator.userAgent.match(/msie [9.]/i)&&document.addEventListener("DOMContentLoaded",function(){var e=document.createElement("script");e.setAttribute("type","text/vbscript"),e.text="Function APNGIEBinaryToBinStr(Binary)\r\n   APNGIEBinaryToBinStr = CStr(Binary)\r\nEnd Function\r\n",document.body.appendChild(e)});for(var u=new Array(256),p=0;256>p;++p){for(var l=p,c=0;8>c;++c)l=1&l?3988292384^l>>>1:l>>>1;u[p]=l}}(this);