/*!
 * Animation Image Splitter v2.0.2 | MIT Licence | 2014 Kenta Moriuchi (@printf_moriken) | http://git.io/bSTspQ
 *
 * This Program is inspired by APNG-canvas.
 * @copyright 2011 David Mzareulyan
 * @link https://github.com/davidmz/apng-canvas
 * @license https://github.com/davidmz/apng-canvas/blob/master/LICENSE (MIT License)
 */
!function(r,e){"use strict";function AISplitter(){}function Frames(r,e){this.width=0,this.height=0,this.frames=[],this.type=e,this.playTime=0,this._onload=[],this._onerror=[],this._onprogress=[],this.loaded=!1,this._urlToFrames(r,e)}function t(r){for(var e=0,t=0;4>t;++t)e+=r.charCodeAt(t)<<8*(3-t);return e}function n(r){for(var e=0,t=0;2>t;++t)e+=r.charCodeAt(t)<<8*(1-t);return e}function o(r,e){var t="";return t+=s(e.length),t+=r,t+=e,t+=s(u(r+e))}function s(r){return String.fromCharCode(r>>24&255,r>>16&255,r>>8&255,255&r)}function i(){this.parts=[]}AISplitter.prototype.read=function(r,e){var t=new Frames(r,e);return t},r.AISplitter=AISplitter,Frames.prototype.on=function(r,e){if("load"!==r&&"error"!==r&&"progress"!==r)throw new Error("Don't exist '"+r+"' event");this["_on"+r].push(e)},Frames.prototype.off=function(r,t){if("load"!==r&&"error"!==r&&"progress"!==r)throw new Error("Don't exist '"+r+"' event");var n=this["_on"+r];if("function"==typeof t)for(var o=0,s=n.length;s>o;++o)n[o]===t&&n.splice(o,1);else t===e&&n.splice(0,n.length)},Frames.prototype.trigger=function(r,t){if("load"!==r&&"error"!==r&&"progress"!==r)throw new Error("Don't exist '"+r+"' event");t=t||[],t.frames=this.frames,t.number=t.number!==e?t.number:null,t.frame=t.frame||null,t.error=t.error||null;for(var n=this["_on"+r],o=0,s=n.length;s>o;++o)n[o].call(this,t)},Frames.prototype._loadend=function(){this.loaded=!0,this.trigger("load")},Frames.prototype._urlToFrames=function(){var r,t,n;!function(){var o=new XMLHttpRequest;if(r=o.responseType!==e,n=o.overrideMimeType!==e&&!r,!r)return void(t=!1);o.open("get","/",!0);try{o.responseType="blob"}catch(s){return void(t=!1)}t=o.response!==e&&"blob"===o.responseType}();var o=navigator.userAgent.match(/msie [9.]/i);return o&&document.addEventListener("DOMContentLoaded",function(){var r=document.createElement("script");r.setAttribute("type","text/vbscript"),r.text="Function IEBinaryToBinStr(Binary)\r\n   IEBinaryToBinStr = CStr(Binary)\r\nEnd Function\r\n",document.body.appendChild(r)}),function(s,i){var a=this,h=new XMLHttpRequest;h.open("GET",s,!0),r?h.responseType=t?"blob":"arraybuffer":n&&h.overrideMimeType("text/plain; charset=x-user-defined"),h.onreadystatechange=function(){if(4==this.readyState&&200==this.status)if(r)if(t){var n=new FileReader;n.readAsBinaryString!==e?(n.onload=function(){a._switchType(this.result,i)},n.readAsBinaryString(this.response)):(n.onload=function(){for(var r="",e=new Uint8Array(this.result),t=e.byteLength,n=0;t>n;++n)r+=String.fromCharCode(e[n]);a._switchType(r,i)},n.readAsArrayBuffer(this.response))}else{for(var s="",h=new Uint8Array(this.response),u=h.byteLength,p=0;u>p;++p)s+=String.fromCharCode(h[p]);a._switchType(s,i)}else{var f="";if(o)for(var d=IEBinaryToBinStr(this.responseBody),p=0,g=d.length;g>p;++p){var l=d.charCodeAt(p);f+=String.fromCharCode(255&l,l>>8&255)}else for(var s=this.responseText,p=0,c=s.length;c>p;++p)f+=String.fromCharCode(255&s.charCodeAt(p));a._switchType(f,i)}else 4==this.readyState&&a.trigger("error",{error:"Can't read file"})},h.send()}}(),Frames.prototype._switchType=function(r,e){"APNG"===e?this._parseAPNG(r):"XJPEG"===e?this._parseXJPEG(r):this.trigger("error",{error:"Don't support type"})},Frames.prototype._parseAPNG=function(r){function e(r,e){return function(){++w,C.trigger("progress",{number:r,frame:e}),w===C.frames.length&&C._loadend()}}function h(){C.trigger("error",{error:"Image creation error"})}if(r.substr(0,8)!==a)return void this.trigger("error",{error:"This file is not PNG"});var u,p,f,d,g="",l="",c=!1,m=8,y=null;do{switch(p=t(r.substr(m,4)),f=r.substr(m+4,4)){case"IHDR":d=r.substr(m+8,p),u=d,this.width=t(d.substr(0,4)),this.height=t(d.substr(4,4));break;case"acTL":c=!0,this.numPlays=t(r.substr(m+12,4));break;case"fcTL":y&&this.frames.push(y),d=r.substr(m+8,p),y={},y.width=t(d.substr(4,4)),y.height=t(d.substr(8,4)),y.left=t(d.substr(12,4)),y.top=t(d.substr(16,4));var v=n(d.substr(20,2)),b=n(d.substr(22,2));0===b&&(b=100),y.delay=1e3*v/b,y.delay<=10&&(y.delay=100),this.playTime+=y.delay,y.disposeOp=d.charCodeAt(24),y.blendOp=d.charCodeAt(25),y.dataParts=[];break;case"fdAT":y&&y.dataParts.push(r.substr(m+12,p-4));break;case"IDAT":y&&y.dataParts.push(r.substr(m+8,p));break;case"IEND":l=r.substr(m,p+12);break;default:g+=r.substr(m,p+12)}m+=p+12}while("IEND"!==f&&m<r.length);if(y&&this.frames.push(y),y=null,!c)return void this.trigger("error",{error:"Non-animated PNG"});for(var w=0,C=this,T=0,A=this.frames.length;A>T;++T){var S=new Image;y=this.frames[T],y.img=S,S.onload=e(T,y),S.onerror=h;var _=new i;_.append(a),u=s(y.width)+s(y.height)+u.substr(8),_.append(o("IHDR",u)),_.append(g);for(var E=0;E<y.dataParts.length;++E)_.append(o("IDAT",y.dataParts[E]));_.append(l),S.src=_.getUrl("image/png"),delete y.dataParts}},Frames.prototype._parseXJPEG=function(r){function e(r,e){return function(){++y,o.trigger("progress",{number:r,frame:e}),y===o.frames.length&&o._loadend()}}function t(){o.trigger("error",{error:"Image creation error"})}var o=this,s=String.fromCharCode(255),a=s+String.fromCharCode(216),u=s+String.fromCharCode(217),p=r.match(new RegExp(a+"[\\s\\S]+?"+u,"g"));if(!("length"in p))return void this.trigger("error",{error:"Can't read JPEG Binary String"});for(var f=function(){if(r.substr(9,12)!==h)return null;for(var e=0,t=1,n=0;4>n;++n)e+=r.charCodeAt(32+n)*t,t*=256;return e/=1e3,o.playTime=0,e}(),d=function(){for(var r=[],e=192;207>=e;)196!==e&&200!==e&&204!==e&&r.push(String.fromCharCode(e)),++e;return new RegExp(s+"["+r.join("")+"]")}(),g=0,l=p.length;l>g;++g){var c={},m=p[g].search(d);c.height=n(p[g].substr(m+5,2)),c.width=n(p[g].substr(m+7,2)),0===g?(this.height=c.height,this.width=c.width,c.top=c.left=0):(c.top=(this.height-c.height)/2,c.left=(this.width-c.width)/2),null!==f&&(c.delay=f,this.playTime+=f),this.frames.push(c)}if(p.length!==this.frames.length)return void this.trigger("error",{error:"Shotage JPEG SOF data"});for(var y=0,g=0,l=this.frames.length;l>g;++g){var v=new Image,c=this.frames[g];c.img=v,v.onload=e(g,c),v.onerror=t;var b=new i;b.append(p[g]),v.src=b.getUrl("image/jpeg")}};var a=String.fromCharCode(137,80,78,71,13,10,26,10),h="AVI ";i.prototype.append=function(r){this.parts.push(r)},i.prototype.getUrl=function(e){return r.btoa?"data:"+e+";base64,"+btoa(this.parts.join("")):"data:"+e+","+escape(this.parts.join(""))};var u=function(){for(var r=new Array(256),e=0;256>e;++e){for(var t=e,n=0;8>n;++n)t=1&t?3988292384^t>>>1:t>>>1;r[e]=t}return function(e){for(var t=-1,n=0,o=e.length;o>n;++n)t=t>>>8^r[255&(t^e.charCodeAt(n))];return-1^t}}()}(this);