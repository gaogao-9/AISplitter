/*!
 * Animation Image Splitter v1.0.1 | MIT Licence | 2014 Kenta Moriuchi (@printf_moriken)
 *
 * This Program is inspired by APNG-canvas.
 * @copyright 2011 David Mzareulyan
 * @link https://github.com/davidmz/apng-canvas
 * @license https://github.com/davidmz/apng-canvas/blob/master/LICENSE (MIT License)
 */
!function(t){"use strict";function r(){}function e(t,r){this.width=0,this.height=0,this.numPlays=0,this.frames=[],this.playTime=0,this._onload=[],this.loaded=!1,this._urlToFrames(t,r)}function a(t){for(var r=0,e=0;4>e;++e)r+=t.charCodeAt(e)<<8*(3-e);return r}function n(t){for(var r=0,e=0;2>e;++e)r+=t.charCodeAt(e)<<8*(1-e);return r}function s(t,r){var e="";return e+=o(r.length),e+=t,e+=r,e+=o(h(t+r))}function o(t){return String.fromCharCode(t>>24&255,t>>16&255,t>>8&255,255&t)}function i(){this.parts=[]}function h(t){for(var r=-1,e=0,a=t.length;a>e;++e)r=r>>>8^f[255&(r^t.charCodeAt(e))];return-1^r}var d=navigator.userAgent.match(/msie [9.]/i);d&&document.addEventListener("DOMContentLoaded",function(){var t=document.createElement("script");t.setAttribute("type","text/vbscript"),t.text="Function IEBinaryToBinStr(Binary)\r\n   IEBinaryToBinStr = CStr(Binary)\r\nEnd Function\r\n",document.body.appendChild(t)}),r.prototype.read=function(t,r){var a=new e(t,r);return a},t.AISplitter=r,e.prototype.on=function(t,r){if("load"!==t)throw new Error("Not exist '"+t+"' event");this._onload.push(r)},e.prototype.off=function(t,r){if("load"!==t)throw new Error("Not exist '"+t+"' event");if("function"==typeof r)for(var e=0,a=this._onload.length;a>e;++e)this._onload[e]===r&&this._onload.splice(e,1);else"undefined"==typeof r&&(this._onload=[])},e.prototype._urlToFrames=function(t,r){var e=this,a=new XMLHttpRequest,n="responseType"in a,s="overrideMimeType"in a;a.open("GET",t,!0),n?a.responseType="blob":s&&a.overrideMimeType("text/plain; charset=x-user-defined"),a.onreadystatechange=function(){if(4==this.readyState&&200==this.status)if(n){var t=new FileReader;"readAsBinaryString"in t?(t.onload=function(){e._switchType(this.result,r)},t.readAsBinaryString(this.response)):(t.onload=function(){for(var t="",a=new Uint8Array(this.result),n=a.byteLength,s=0;n>s;++s)t+=String.fromCharCode(a[s]);e._switchType(t,r)},t.readAsArrayBuffer(this.response))}else{var a="";if(d)for(var s=IEBinaryToBinStr(this.responseBody),o=0,i=s.length;i>o;++o){var h=s.charCodeAt(o);a+=String.fromCharCode(255&h,h>>8&255)}else for(var p=this.responseText,f=0,u=p.length;u>f;++f)a+=String.fromCharCode(255&p.charCodeAt(f));e._switchType(a,r)}else if(4==this.readyState)throw new Error("Can't read file")},a.send()},e.prototype._switchType=function(t,r){if("image/png"===r)this._parseAPNG(t);else{if("image/jpeg"!==r)throw new Error("Not support type");this._parseMJPEG(t)}},e.prototype._parseAPNG=function(t){if(t.substr(0,8)!==p)throw new TypeError("This file is not PNG");var r,e,h,d,f="",u="",l=!1,c=8,g=null;do{switch(e=a(t.substr(c,4)),h=t.substr(c+4,4)){case"IHDR":d=t.substr(c+8,e),r=d,this.width=a(d.substr(0,4)),this.height=a(d.substr(4,4));break;case"acTL":l=!0,this.numPlays=a(t.substr(c+12,4));break;case"fcTL":g&&this.frames.push(g),d=t.substr(c+8,e),g={},g.width=a(d.substr(4,4)),g.height=a(d.substr(8,4)),g.left=a(d.substr(12,4)),g.top=a(d.substr(16,4));var y=n(d.substr(20,2)),m=n(d.substr(22,2));0===m&&(m=100),g.delay=1e3*y/m,g.delay<=10&&(g.delay=100),this.playTime+=g.delay,g.disposeOp=d.charCodeAt(24),g.blendOp=d.charCodeAt(25),g.dataParts=[];break;case"fdAT":g&&g.dataParts.push(t.substr(c+12,e-4));break;case"IDAT":g&&g.dataParts.push(t.substr(c+8,e));break;case"IEND":u=t.substr(c,e+12);break;default:f+=t.substr(c,e+12)}c+=e+12}while("IEND"!==h&&c<t.length);if(g&&this.frames.push(g),console.log(this.frames),g=null,!l)throw new TypeError("Non-animated PNG");for(var w=0,v=this,b=0,C=this.frames.length;C>b;++b){var T=new Image;g=this.frames[b],g.img=T,T.onload=function(){++w,w===v.frames.length&&v._loadend()},T.onerror=function(){throw new Error("Image creation error")};var A=new i;A.append(p),r=o(g.width)+o(g.height)+r.substr(8),A.append(s("IHDR",r)),A.append(f);for(var E=0;E<g.dataParts.length;++E)A.append(s("IDAT",g.dataParts[E]));A.append(u),T.src=A.getUrl("image/png"),delete g.dataParts}},e.prototype._parseMJPEG=function(t){for(var r=String.fromCharCode(255),e=r+String.fromCharCode(216),a=r+String.fromCharCode(217),s=0,o=1,h=0;4>h;++h)s+=t.charCodeAt(32+c)*o,o*=256;s/=1e3;for(var d,p=t.match(new RegExp(e+"[\\s\\S]+?"+a,"g")),h=0,f=p.length;f>h;++h){for(var u=[],l=192;207>=l;)196!==l&&200!==l&&204!==l&&u.push(String.fromCharCode(l)),++l;d={};var g=p[h].search(new RegExp(r+"["+u.join("")+"]"));d.height=n(p[h].substr(g+5,2)),d.width=n(p[h].substr(g+7,2)),d.top=d.left=0,d.delay=s,this.playTime+=s,this.frames.push(d)}if(p.length!==this.frames.length)throw new TypeError("Shotage JPG SOF data");this.height=this.frames[0].height,this.width=this.frames[0].width;for(var y=0,m=this,h=0,f=this.frames.length;f>h;++h){var w=new Image;this.frames[h].img=w,w.onload=function(){++y,y===m.frames.length&&m._loadend()},w.onerror=function(){throw new Error("Image creation error")};var v=new i;v.append(p[h]),w.src=v.getUrl("image/jpeg")}},e.prototype._loadend=function(){this.loaded=!0;for(var t=0,r=this._onload.length;r>t;++t)this._onload[t].call(this)};var p=String.fromCharCode(137,80,78,71,13,10,26,10);i.prototype.append=function(t){this.parts.push(t)},i.prototype.getUrl=function(r){return t.btoa?"data:"+r+";base64,"+btoa(this.parts.join("")):"data:"+r+","+escape(this.parts.join(""))};for(var f=new Array(256),u=0;256>u;++u){for(var l=u,c=0;8>c;++c)l=1&l?3988292384^l>>>1:l>>>1;f[u]=l}}(this);