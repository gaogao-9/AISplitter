/*!
 * Animation Image Splitter v2.0.2 | MIT Licence | 2014 Kenta Moriuchi (@printf_moriken) | http://git.io/bSTspQ
 *
 * This Program is inspired by APNG-canvas.
 * @copyright 2011 David Mzareulyan
 * @link https://github.com/davidmz/apng-canvas
 * @license https://github.com/davidmz/apng-canvas/blob/master/LICENSE (MIT License)
 */
!function(r,t){"use strict";function AISplitter(r){this._path="",this.path=r}function Frames(r,t){this.width=0,this.height=0,this.frames=[],this.type=t,this.playTime=0,this._onload=[],this._onerror=[],this._onprogress=[],this.loaded=!1,this._urlToFrames(r,t)}function e(r){for(var t=0,e=0;4>e;++e)t+=r.charCodeAt(e)<<8*(3-e);return t}function n(r){for(var t=0,e=0;2>e;++e)t+=r.charCodeAt(e)<<8*(1-e);return t}function o(r,t){var e="";return e+=s(t.length),e+=r,e+=t,e+=s(u(r+t))}function s(r){return String.fromCharCode(r>>24&255,r>>16&255,r>>8&255,255&r)}function i(){this.parts=[]}AISplitter.prototype={set path(r){"string"==typeof r&&(this._path=r.toString())},get path(){return this._path}},AISplitter.prototype.read=function(r,t){var e=new Frames(r,t);return e},r.AISplitter=AISplitter,Frames.prototype.on=function(r,t){if("load"!==r&&"error"!==r&&"progress"!==r)throw new Error("Don't exist '"+r+"' event");this["_on"+r].push(t)},Frames.prototype.off=function(r,e){if("load"!==r&&"error"!==r&&"progress"!==r)throw new Error("Don't exist '"+r+"' event");var n=this["_on"+r];if("function"==typeof e)for(var o=0,s=n.length;s>o;++o)n[o]===e&&n.splice(o,1);else e===t&&n.splice(0,n.length)},Frames.prototype.trigger=function(r,e){if("load"!==r&&"error"!==r&&"progress"!==r)throw new Error("Don't exist '"+r+"' event");e=e||[],e.frames=this.frames,e.number=e.number!==t?e.number:null,e.frame=e.frame||null,e.error=e.error||null;for(var n=this["_on"+r],o=0,s=n.length;s>o;++o)n[o].call(this,e)},Frames.prototype._loadend=function(){this.loaded=!0,this.trigger("load")},Frames.prototype._urlToFrames=function(){var r,e,n;!function(){var o=new XMLHttpRequest;if(r=o.responseType!==t,n=o.overrideMimeType!==t&&!r,!r)return void(e=!1);o.open("get","/",!0);try{o.responseType="blob"}catch(s){return void(e=!1)}e=o.response!==t&&"blob"===o.responseType}();var o=navigator.userAgent.match(/msie [9.]/i);return o&&document.addEventListener("DOMContentLoaded",function(){var r=document.createElement("script");r.setAttribute("type","text/vbscript"),r.text="Function IEBinaryToBinStr(Binary)\r\n   IEBinaryToBinStr = CStr(Binary)\r\nEnd Function\r\n",document.body.appendChild(r)}),function(s,i){var a=this,h=new XMLHttpRequest;h.open("GET",s,!0),r?h.responseType=e?"blob":"arraybuffer":n&&h.overrideMimeType("text/plain; charset=x-user-defined"),h.onreadystatechange=function(n){if(4==this.readyState&&200==this.status)if(r)if(e){var s=new FileReader;s.readAsBinaryString!==t?(s.onload=function(){a._switchType(this.result,i)},s.readAsBinaryString(this.response)):(s.onload=function(){for(var r="",t=new Uint8Array(this.result),e=t.byteLength,n=0;e>n;++n)r+=String.fromCharCode(t[n]);a._switchType(r,i)},s.readAsArrayBuffer(this.response))}else{for(var h="",u=new Uint8Array(this.response),p=u.byteLength,f=0;p>f;++f)h+=String.fromCharCode(u[f]);a._switchType(h,i)}else{var d="";if(o)for(var g=IEBinaryToBinStr(this.responseBody),f=0,l=g.length;l>f;++f){var c=g.charCodeAt(f);d+=String.fromCharCode(255&c,c>>8&255)}else for(var h=this.responseText,f=0,y=h.length;y>f;++f)d+=String.fromCharCode(255&h.charCodeAt(f));a._switchType(d,i)}else 4==this.readyState&&a.trigger("error",{error:"Can't read file"})},h.send()}}(),Frames.prototype._switchType=function(r,t){"APNG"===t?this._parseAPNG(r):"XJPEG"===t?this._parseXJPEG(r):this.trigger("error",{error:"Don't support type"})},Frames.prototype._parseAPNG=function(r){function t(r,t){return function(){++w,C.trigger("progress",{number:r,frame:t}),w===C.frames.length&&C._loadend()}}function h(){C.trigger("error",{error:"Image creation error"})}if(r.substr(0,8)!==a)return void this.trigger("error",{error:"This file is not PNG"});var u,p,f,d,g="",l="",c=!1,y=8,m=null;do{switch(p=e(r.substr(y,4)),f=r.substr(y+4,4)){case"IHDR":d=r.substr(y+8,p),u=d,this.width=e(d.substr(0,4)),this.height=e(d.substr(4,4));break;case"acTL":c=!0,this.numPlays=e(r.substr(y+12,4));break;case"fcTL":m&&this.frames.push(m),d=r.substr(y+8,p),m={},m.width=e(d.substr(4,4)),m.height=e(d.substr(8,4)),m.left=e(d.substr(12,4)),m.top=e(d.substr(16,4));var b=n(d.substr(20,2)),v=n(d.substr(22,2));0===v&&(v=100),m.delay=1e3*b/v,m.delay<=10&&(m.delay=100),this.playTime+=m.delay,m.disposeOp=d.charCodeAt(24),m.blendOp=d.charCodeAt(25),m.dataParts=[];break;case"fdAT":m&&m.dataParts.push(r.substr(y+12,p-4));break;case"IDAT":m&&m.dataParts.push(r.substr(y+8,p));break;case"IEND":l=r.substr(y,p+12);break;default:g+=r.substr(y,p+12)}y+=p+12}while("IEND"!==f&&y<r.length);if(m&&this.frames.push(m),m=null,!c)return void this.trigger("error",{error:"Non-animated PNG"});for(var w=0,C=this,T=0,A=this.frames.length;A>T;++T){var S=new Image;m=this.frames[T],m.img=S,S.onload=t(T,m),S.onerror=h;var _=new i;_.append(a),u=s(m.width)+s(m.height)+u.substr(8),_.append(o("IHDR",u)),_.append(g);for(var E=0;E<m.dataParts.length;++E)_.append(o("IDAT",m.dataParts[E]));_.append(l),S.src=_.getUrl("image/png"),delete m.dataParts}},Frames.prototype._parseXJPEG=function(r){function t(r,t){return function(){++m,o.trigger("progress",{number:r,frame:t}),m===o.frames.length&&o._loadend()}}function e(){o.trigger("error",{error:"Image creation error"})}var o=this,s=String.fromCharCode(255),a=s+String.fromCharCode(216),u=s+String.fromCharCode(217),p=r.match(new RegExp(a+"[\\s\\S]+?"+u,"g"));if(!("length"in p))return void this.trigger("error",{error:"Can't read JPEG Binary String"});for(var f=function(){if(r.substr(9,12)!==h)return null;for(var t=0,e=1,n=0;4>n;++n)t+=r.charCodeAt(32+n)*e,e*=256;return t/=1e3,o.playTime=0,t}(),d=function(){for(var r=[],t=192;207>=t;)196!==t&&200!==t&&204!==t&&r.push(String.fromCharCode(t)),++t;return new RegExp(s+"["+r.join("")+"]")}(),g=0,l=p.length;l>g;++g){var c={},y=p[g].search(d);c.height=n(p[g].substr(y+5,2)),c.width=n(p[g].substr(y+7,2)),0===g?(this.height=c.height,this.width=c.width,c.top=c.left=0):(c.top=(this.height-c.height)/2,c.left=(this.width-c.width)/2),null!==f&&(c.delay=f,this.playTime+=f),this.frames.push(c)}if(p.length!==this.frames.length)return void this.trigger("error",{error:"Shotage JPEG SOF data"});for(var m=0,g=0,l=this.frames.length;l>g;++g){var b=new Image,c=this.frames[g];c.img=b,b.onload=t(g,c),b.onerror=e;var v=new i;v.append(p[g]),b.src=v.getUrl("image/jpeg")}};var a=String.fromCharCode(137,80,78,71,13,10,26,10),h="AVI ";i.prototype.append=function(r){this.parts.push(r)},i.prototype.getUrl=function(t){return r.btoa?"data:"+t+";base64,"+btoa(this.parts.join("")):"data:"+t+","+escape(this.parts.join(""))};var u=function(){for(var r=new Array(256),t=0;256>t;++t){for(var e=t,n=0;8>n;++n)e=1&e?3988292384^e>>>1:e>>>1;r[t]=e}return function(t){for(var e=-1,n=0,o=t.length;o>n;++n)e=e>>>8^r[255&(e^t.charCodeAt(n))];return-1^e}}()}((this||0).self||global);