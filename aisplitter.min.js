/*!
 * Animation Image Splitter v2.0.1 | MIT Licence | 2014 Kenta Moriuchi (@printf_moriken) | http://git.io/bSTspQ
 *
 * This Program is inspired by APNG-canvas.
 * @copyright 2011 David Mzareulyan
 * @link https://github.com/davidmz/apng-canvas
 * @license https://github.com/davidmz/apng-canvas/blob/master/LICENSE (MIT License)
 */
!function(r,t){"use strict";function AISplitter(){}function Frames(r,t){this.width=0,this.height=0,this.frames=[],this.type=t,this._onload=[],this._onerror=[],this._onprogress=[],this.loaded=!1,this._urlToFrames(r,t)}function e(r){for(var t=0,e=0;4>e;++e)t+=r.charCodeAt(e)<<8*(3-e);return t}function n(r){for(var t=0,e=0;2>e;++e)t+=r.charCodeAt(e)<<8*(1-e);return t}function s(r,t){var e="";return e+=o(t.length),e+=r,e+=t,e+=o(a(r+t))}function o(r){return String.fromCharCode(r>>24&255,r>>16&255,r>>8&255,255&r)}function i(){this.parts=[]}function a(r){for(var t=-1,e=0,n=r.length;n>e;++e)t=t>>>8^d[255&(t^r.charCodeAt(e))];return-1^t}var h=function(){var r=new XMLHttpRequest;r.open("get","/",!0);try{r.responseType="blob"}catch(e){return!1}return r.response!==t&&"blob"===r.responseType}(),u=navigator.userAgent.match(/msie [9.]/i);u&&document.addEventListener("DOMContentLoaded",function(){var r=document.createElement("script");r.setAttribute("type","text/vbscript"),r.text="Function IEBinaryToBinStr(Binary)\r\n   IEBinaryToBinStr = CStr(Binary)\r\nEnd Function\r\n",document.body.appendChild(r)}),AISplitter.prototype.read=function(r,t){var e=new Frames(r,t);return e},r.AISplitter=AISplitter,Frames.prototype.on=function(r,t){if("load"!==r&&"error"!==r&&"progress"!==r)throw new Error("Don't exist '"+r+"' event");this["_on"+r].push(t)},Frames.prototype.off=function(r,e){if("load"!==r&&"error"!==r&&"progress"!==r)throw new Error("Don't exist '"+r+"' event");var n=this["_on"+r];if("function"==typeof e)for(var s=0,o=n.length;o>s;++s)n[s]===e&&n.splice(s,1);else e===t&&n.splice(0,n.length)},Frames.prototype.trigger=function(r,e){if("load"!==r&&"error"!==r&&"progress"!==r)throw new Error("Don't exist '"+r+"' event");e=e||[],e.frames=this.frames,e.number=e.number!==t?e.number:null,e.frame=e.frame||null,e.error=e.error||null;for(var n=this["_on"+r],s=0,o=n.length;o>s;++s)n[s].call(this,e)},Frames.prototype._loadend=function(){this.loaded=!0,this.trigger("load")},Frames.prototype._urlToFrames=function(r,e){var n=this,s=new XMLHttpRequest,o=s.responseType!==t;s.open("GET",r,!0),o?s.responseType=h?"blob":"arraybuffer":s.overrideMimeType("text/plain; charset=x-user-defined"),s.onreadystatechange=function(){if(4==this.readyState&&200==this.status)if(o)if(h){var r=new FileReader;r.readAsBinaryString!==t?(r.onload=function(){n._switchType(this.result,e)},r.readAsBinaryString(this.response)):(r.onload=function(){for(var r="",t=new Uint8Array(this.result),s=t.byteLength,o=0;s>o;++o)r+=String.fromCharCode(t[o]);n._switchType(r,e)},r.readAsArrayBuffer(this.response))}else{for(var s="",i=new Uint8Array(this.response),a=i.byteLength,p=0;a>p;++p)s+=String.fromCharCode(i[p]);n._switchType(s,e)}else{var f="";if(u)for(var d=IEBinaryToBinStr(this.responseBody),p=0,g=d.length;g>p;++p){var l=d.charCodeAt(p);f+=String.fromCharCode(255&l,l>>8&255)}else for(var s=this.responseText,p=0,c=s.length;c>p;++p)f+=String.fromCharCode(255&s.charCodeAt(p));n._switchType(f,e)}else 4==this.readyState&&n.trigger("error",{error:"Can't read file"})},s.send()},Frames.prototype._switchType=function(r,t){"APNG"===t?this._parseAPNG(r):"XJPEG"===t?this._parseXJPEG(r):this.trigger("error",{error:"Don't support type"})},Frames.prototype._parseAPNG=function(r){function t(r,t){return function(){++w,C.trigger("progress",{number:r,frame:t}),w===C.frames.length&&C._loadend()}}function a(){C.trigger("error",{error:"Image creation error"})}if(r.substr(0,8)!==p)return void this.trigger("error",{error:"This file is not PNG"});var h,u,f,d,g="",l="",c=!1,m=8,y=null;do{switch(u=e(r.substr(m,4)),f=r.substr(m+4,4)){case"IHDR":d=r.substr(m+8,u),h=d,this.width=e(d.substr(0,4)),this.height=e(d.substr(4,4));break;case"acTL":c=!0,this.numPlays=e(r.substr(m+12,4));break;case"fcTL":y&&this.frames.push(y),d=r.substr(m+8,u),y={},y.width=e(d.substr(4,4)),y.height=e(d.substr(8,4)),y.left=e(d.substr(12,4)),y.top=e(d.substr(16,4));var b=n(d.substr(20,2)),v=n(d.substr(22,2));0===v&&(v=100),y.delay=1e3*b/v,y.delay<=10&&(y.delay=100),this.playTime+=y.delay,y.disposeOp=d.charCodeAt(24),y.blendOp=d.charCodeAt(25),y.dataParts=[];break;case"fdAT":y&&y.dataParts.push(r.substr(m+12,u-4));break;case"IDAT":y&&y.dataParts.push(r.substr(m+8,u));break;case"IEND":l=r.substr(m,u+12);break;default:g+=r.substr(m,u+12)}m+=u+12}while("IEND"!==f&&m<r.length);if(y&&this.frames.push(y),y=null,!c)return void this.trigger("error",{error:"Non-animated PNG"});for(var w=0,C=this,T=0,A=this.frames.length;A>T;++T){var S=new Image;y=this.frames[T],y.img=S,S.onload=t(T,y),S.onerror=a;var _=new i;_.append(p),h=o(y.width)+o(y.height)+h.substr(8),_.append(s("IHDR",h)),_.append(g);for(var E=0;E<y.dataParts.length;++E)_.append(s("IDAT",y.dataParts[E]));_.append(l),S.src=_.getUrl("image/png"),delete y.dataParts}},Frames.prototype._parseXJPEG=function(r){function t(r,t){return function(){++y,s.trigger("progress",{number:r,frame:t}),y===s.frames.length&&s._loadend()}}function e(){s.trigger("error",{error:"Image creation error"})}var s=this,o=String.fromCharCode(255),a=o+String.fromCharCode(216),h=o+String.fromCharCode(217),u=r.match(new RegExp(a+"[\\s\\S]+?"+h,"g"));if(!("length"in u))return void this.trigger("error",{error:"Can't read JPEG Binary String"});for(var p=function(){if(r.substr(9,12)!==f)return null;for(var t=0,e=1,n=0;4>n;++n)t+=r.charCodeAt(32+n)*e,e*=256;return t/=1e3,s.playTime=0,t}(),d=function(){for(var r=[],t=192;207>=t;)196!==t&&200!==t&&204!==t&&r.push(String.fromCharCode(t)),++t;return new RegExp(o+"["+r.join("")+"]")}(),g=0,l=u.length;l>g;++g){var c={},m=u[g].search(d);c.height=n(u[g].substr(m+5,2)),c.width=n(u[g].substr(m+7,2)),0===g?(this.height=c.height,this.width=c.width,c.top=c.left=0):(c.top=(this.height-c.height)/2,c.left=(this.width-c.width)/2),null!==p&&(c.delay=p,this.playTime+=p),this.frames.push(c)}if(u.length!==this.frames.length)return void this.trigger("error",{error:"Shotage JPEG SOF data"});for(var y=0,g=0,l=this.frames.length;l>g;++g){var b=new Image,c=this.frames[g];c.img=b,b.onload=t(g,c),b.onerror=e;var v=new i;v.append(u[g]),b.src=v.getUrl("image/jpeg")}};var p=String.fromCharCode(137,80,78,71,13,10,26,10),f="AVI ";i.prototype.append=function(r){this.parts.push(r)},i.prototype.getUrl=function(t){return r.btoa?"data:"+t+";base64,"+btoa(this.parts.join("")):"data:"+t+","+escape(this.parts.join(""))};for(var d=new Array(256),g=0;256>g;++g){for(var l=g,c=0;8>c;++c)l=1&l?3988292384^l>>>1:l>>>1;d[g]=l}}(this);